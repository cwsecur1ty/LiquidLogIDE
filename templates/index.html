<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiquidLogIDE</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/matchesonscrollbar.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/match-highlighter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>
    {% raw %}
    <script>
        // Define Liquid mode
        CodeMirror.defineMode("liquid", function(config, parserConfig) {
            return {
                startState: function() {
                    return {
                        inLiquid: false,
                        inTag: false,
                        inVariable: false
                    };
                },
                token: function(stream, state) {
                    // Liquid tags
                    if (stream.match("{%")) {
                        state.inLiquid = true;
                        state.inTag = true;
                        return "liquid-tag";
                    }
                    if (stream.match("{{")) {
                        state.inLiquid = true;
                        state.inVariable = true;
                        return "liquid-variable";
                    }
                    if (state.inLiquid) {
                        if (stream.match("%}") && state.inTag) {
                            state.inLiquid = false;
                            state.inTag = false;
                            return "liquid-tag";
                        }
                        if (stream.match("}}") && state.inVariable) {
                            state.inLiquid = false;
                            state.inVariable = false;
                            return "liquid-variable";
                        }
                        if (state.inTag) {
                            if (stream.match(/\b(if|else|elsif|endif|for|endfor|assign|capture|endcapture|case|when|endcase)\b/)) {
                                return "liquid-keyword";
                            }
                            stream.next();
                            return "liquid-tag";
                        }
                        if (state.inVariable) {
                            stream.next();
                            return "liquid-variable";
                        }
                    }
                    stream.next();
                    return null;
                }
            };
        });

        // Add Liquid styles
        CodeMirror.defineMIME("text/liquid", "liquid");
    </script>
    {% endraw %}
    <style>
        .CodeMirror {
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .cm-liquid-tag {
            color: #f92672;
        }
        .cm-liquid-variable {
            color: #a6e22e;
        }
        .cm-liquid-keyword {
            color: #66d9ef;
            font-weight: bold;
        }
        
        /* Add this CSS for the matching highlights */
        .cm-match-highlight {
            background-color: rgba(255, 204, 0, 0.3); /* Subtle yellow highlight */
            border-radius: 2px;
        }
        
        /* Style for active line highlighting */
        .CodeMirror-activeline-background {
            background-color: rgba(255, 255, 255, 0.07);
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="company-name">
                <h3>Name</h3>
                <input type="text" id="company-name" placeholder="Enter company name" value="COMPANY">
            </div>
            <div class="color-theme">
                <div class="collapsible-header">
                    <h3>Color Theme</h3>
                    <button class="toggle-btn"><i class="fas fa-chevron-down"></i></button>
                </div>
                <div class="collapsible-content">
                    <div class="theme-buttons">
                        <button class="theme-btn active" data-theme="purple">Purple</button>
                        <button class="theme-btn" data-theme="red">Candy Red</button>
                        <button class="theme-btn" data-theme="green">Lime Green</button>
                    </div>
                </div>
            </div>
            <div class="insert-mode">
                <h3>Insert Mode</h3>
                <div class="toggle-container">
                    <label class="toggle-label">
                        <input type="radio" name="insert-mode" value="cursor" checked>
                        <span>Cursor Position</span>
                    </label>
                    <label class="toggle-label">
                        <input type="radio" name="insert-mode" value="auto">
                        <span>Auto Insert</span>
                    </label>
                </div>
            </div>
            <div class="system-selector">
                <h3>Systems</h3>
                <div class="system-buttons">
                    <button class="system-btn active" data-system="windows">Windows</button>
                    <button class="system-btn" data-system="linux">Linux</button>
                    <button class="system-btn" data-system="entra">Entra ID</button>
                    <button class="system-btn" data-system="cloudflare">Cloudflare</button>
                    <button class="system-btn" data-system="Bitdefender">Bitdefender</button>
                    
                    <div class="system-upload">
                        <input type="file" id="log-json-upload" accept=".json" style="display: none;">
                        <button class="system-btn log-upload-btn">
                            <i class="fas fa-upload"></i> Custom Log Format
                        </button>
                    </div>
                </div>
            </div>
            <div class="outcome-templates">
                <h3>Outcome Templates</h3>
                <div id="windows-complex" class="system-complex active">
                    <button class="complex-btn" data-template="windows-outcome">Outcome Processing (Windows)</button>
                </div>
                <div id="linux-complex" class="system-complex">
                    <button class="complex-btn" data-template="linux-outcome">Outcome Processing (Linux)</button>
                </div>
                <div id="entra-complex" class="system-complex">
                    <button class="complex-btn" data-template="entra-outcome">Outcome Processing (Entra ID)</button>
                </div>
                <div id="cloudflare-complex" class="system-complex">
                    <button class="complex-btn" data-template="cloudflare-outcome">Outcome Processing (Cloudflare)</button>
                </div>
            </div>
            <div class="log-variables">
                <h3>Log Variables</h3>
                <div id="windows-options" class="system-options active">
                    <button class="template-btn" data-template="subject-user">Subject User</button>
                    <button class="template-btn" data-template="subject-user-sid">Subject User SID</button>
                    <button class="template-btn" data-template="target-domain-name">Target Domain Name</button>
                    <button class="template-btn" data-template="target-user">Target User</button>
                    <button class="template-btn" data-template="target-sid">Target SID</button>
                    <button class="template-btn" data-template="windows-hostname">Hostname</button>
                    <button class="template-btn" data-template="windows-message">Message</button>
                    <button class="template-btn" data-template="event-type">Event Type</button>
                    <button class="template-btn" data-template="event-code">Event Code</button>
                    <button class="template-btn" data-template="target-object">Target Object</button>
                </div>
                <div id="linux-options" class="system-options">
                    <button class="template-btn" data-template="user">User</button>
                    <button class="template-btn" data-template="command">Command</button>
                    <button class="template-btn" data-template="process">Process</button>
                </div>
                <div id="entra-options" class="system-options">
                    <button class="template-btn" data-template="user-id">User ID</button>
                    <button class="template-btn" data-template="result-status">Result Status</button>
                    <button class="template-btn" data-template="user-key">User Key</button>
                    <button class="template-btn" data-template="operation">Operation</button>
                    <button class="template-btn" data-template="object-id">Object ID</button>
                </div>
                <div id="cloudflare-options" class="system-options">
                    <button class="template-btn" data-template="resource-type">Resource Type</button>
                    <button class="template-btn" data-template="resource-id">Resource ID</button>
                    <button class="template-btn" data-template="actor-ip">Actor IP</button>
                    <button class="template-btn" data-template="actor-type">Actor Type</button>
                    <button class="template-btn" data-template="actor-id">Actor ID</button>
                    <button class="template-btn" data-template="actor-email">Actor Email</button>
                    <button class="template-btn" data-template="action-type">Action Type</button>
                    <button class="template-btn" data-template="action-result">Action Result</button>
                    <button class="template-btn" data-template="action-info">Action Info</button>
                </div>
            </div>
            <div id="custom-log-options" class="system-options">
                <!-- Dynamic variables will be added here -->
                <div class="custom-log-empty">Upload a JSON log file to extract variables</div>
            </div>
        </aside>
        <div class="main-content">
            <header>
                <h1>LiquidLogIDE ðŸ«—</h1>
                <div class="controls">
                    <div class="file-upload">
                        <input type="file" id="json-upload" accept=".json" style="display: none;">
                        <button id="upload-btn"><span>Upload Sigma JSON</span></button>
                    </div>
                    <button id="save-btn"><span>Save Liquid Template</span></button>
                    <div class="file-upload">
                        <input type="file" id="template-upload" accept=".liquid" style="display: none;">
                        <button id="load-btn"><span>Load Liquid Template</span></button>
                    </div>
                </div>
            </header>
            <main>
                <div class="editor-container">
                    <div class="editor-header">
                        <h2>Liquid Template</h2>
                        <div class="editor-controls">
                            <button id="undo-btn" title="Undo"><i class="fas fa-undo"></i></button>
                            <button id="redo-btn" title="Redo"><i class="fas fa-redo"></i></button>
                            <button id="format-btn" title="Format"><i class="fas fa-code"></i></button>
                            <button id="clear-btn" title="Clear"><i class="fas fa-trash"></i></button>
                            <button id="run-btn" title="Run Template"><i class="fas fa-play"></i><span>Run</span></button>
                            <div class="log-count editor-log-count">
                                <label for="log-count-select">Logs:</label>
                                <select id="log-count-select" class="log-count-select">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="editor"></div>
                </div>
                <div class="output-container">
                    <h3>Output - Work In Progress</h3>
                    <div id="output"></div>
                </div>
            </main>
        </div>
    </div>

    {% raw %}
    <script>
        // Initialize CodeMirror
        const editor = CodeMirror(document.getElementById('editor'), {
            mode: 'liquid',
            theme: 'monokai',
            lineNumbers: true,
            autoCloseTags: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            lineWrapping: true,
            styleActiveLine: true,
            highlightSelectionMatches: {
                minChars: 2,
                style: 'match-highlight',
                showToken: false,
                annotateScrollbar: false
            },
            extraKeys: {
                "Ctrl-Space": "autocomplete"
            }
        });

        // Ensure the CodeMirror instance has the necessary options
        editor.setOption("extraKeys", {
            "Ctrl-Space": "autocomplete",
            "Tab": function(cm) {
                // Convert tabs to spaces for consistent indentation
                const spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
                cm.replaceSelection(spaces);
            }
        });

        // Editor control buttons
        document.getElementById('undo-btn').addEventListener('click', () => {
            editor.undo();
        });

        document.getElementById('redo-btn').addEventListener('click', () => {
            editor.redo();
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the editor?')) {
                editor.setValue('');
            }
        });

        document.getElementById('format-btn').addEventListener('click', () => {
            const content = editor.getValue();
            // Basic formatting - you might want to enhance this
            const formatted = content
                .replace(/\{\{/g, '{{ ')
                .replace(/\}\}/g, ' }}')
                .replace(/\{%/g, '{% ')
                .replace(/%\}/g, ' %}')
                .replace(/\s+/g, ' ')
                .trim();
            editor.setValue(formatted);
        });

        // System selection handling
        document.querySelectorAll('.system-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all system buttons and options
                document.querySelectorAll('.system-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.system-options').forEach(opt => opt.classList.remove('active'));
                document.querySelectorAll('.system-complex').forEach(opt => opt.classList.remove('active'));
                
                // Add active class to clicked button and corresponding options
                this.classList.add('active');
                document.getElementById(this.dataset.system + '-options').classList.add('active');
                document.getElementById(this.dataset.system + '-complex').classList.add('active');
            });
        });

        // Complex template button handling
        document.querySelectorAll('.complex-btn').forEach(button => {
            button.addEventListener('click', function() {
                const template = this.dataset.template;
                let insertText = '';
                
                switch(template) {
                    case 'windows-outcome':
                        insertText = `{% assign result = log_entries[0].event.outcome | strip -%}
  {% if result == "failure" -%}
    {% assign result = "failed" %}
  {% elsif result == "success" -%}
    {% assign result = "succeeded" %}
  {% endif -%}`;
                        break;
                    case 'linux-outcome':
                        insertText = `{% assign result = log_entries[0].event.outcome | strip -%}
  {% if result == "failure" -%}
    {% assign result = "failed" %}
  {% elsif result == "success" -%}
    {% assign result = "succeeded" %}
  {% endif -%}`;
                        break;
                    case 'entra-outcome':
                        insertText = `{% assign result = log_entries[0].event.outcome | strip -%}
  {% if result == "failure" -%}
    {% assign result = "failed" %}
  {% elsif result == "success" -%}
    {% assign result = "succeeded" %}
  {% endif -%}`;
                        break;
                    case 'cloudflare-outcome':
                        insertText = `{% assign result = log_entries[0].event.outcome | strip -%}
  {% if result == "failure" -%}
    {% assign result = "failed" %}
  {% elsif result == "success" -%}
    {% assign result = "succeeded" %}
  {% endif -%}`;
                        break;
                }
                
                const insertMode = document.querySelector('input[name="insert-mode"]:checked').value;
                
                if (insertMode === 'cursor') {
                    // Insert at cursor position
                    const cursor = editor.getCursor();
                    editor.replaceRange(insertText + '\n', cursor);
                } else {
                    // Auto insert into the appropriate section
                    const content = editor.getValue();
                    const singleEventSection = content.indexOf('{% if log_entries.size == 1 -%}');
                    const multipleEventsSection = content.indexOf('{% else -%}');
                    
                    if (singleEventSection !== -1 && multipleEventsSection !== -1) {
                        // Find the position after the activity description in single event section
                        const singleEventDescEnd = content.indexOf('\n\n', singleEventSection) + 2;
                        
                        // Find the position in the multiple events section
                        const forLoopStart = content.indexOf('{% for log_entry in log_entries %}', multipleEventsSection);
                        const forLoopEnd = content.indexOf('{% endfor -%}', forLoopStart);
                        
                        // Insert in single event section with proper indentation
                        editor.replaceRange('  ' + insertText + '\n', {line: editor.posFromIndex(singleEventDescEnd).line, ch: 0});
                        
                        // Insert in multiple events section inside the for loop
                        if (forLoopStart !== -1 && forLoopEnd !== -1) {
                            // Find the last line inside the for loop
                            let lastLineInLoop = forLoopStart;
                            let currentPos = forLoopStart;
                            while (currentPos < forLoopEnd) {
                                const nextNewline = content.indexOf('\n', currentPos);
                                if (nextNewline === -1 || nextNewline > forLoopEnd) break;
                                lastLineInLoop = nextNewline;
                                currentPos = nextNewline + 1;
                            }
                            
                            // Insert after the last line in the for loop with proper indentation
                            const insertLine = editor.posFromIndex(lastLineInLoop).line;
                            editor.replaceRange('  ' + insertText + '\n', {line: insertLine, ch: 0});
                        }
                    }
                }
            });
        });

        // Log Variables button handling
        document.querySelectorAll('.template-btn').forEach(button => {
            button.addEventListener('click', function() {
                const template = this.dataset.template;
                let insertText = '';
                
                switch(template) {
                    case 'subject-user':
                        insertText = '* Subject User: `{{ log_entry.SubjectUserName }}`';
                        break;
                    case 'subject-user-sid':
                        insertText = '* Subject User SID: `{{ log_entry.SubjectUserSid }}`';
                        break;
                    case 'target-domain-name':
                        insertText = '* Target Domain Name: `{{ log_entry.TargetDomainName }}`';
                        break;
                    case 'target-user':
                        insertText = '* Target User: `{{ log_entry.TargetUserName }}`';
                        break;
                    case 'target-sid':
                        insertText = '* Target SID: `{{ log_entry.TargetUserSid }}`';
                        break;
                    case 'windows-hostname':
                        insertText = '* Hostname: `{{ log_entry.hostname }}`';
                        break;
                    case 'windows-message':
                        insertText = '* Message: `{{ log_entry.message }}`';
                        break;
                    case 'event-type':
                        insertText = '* Event Type: `{{ log_entry.EventType }}`';
                        break;
                    case 'event-code':
                        insertText = '* Event Code: `{{ log_entry.event.code }}`';
                        break;
                    case 'target-object':
                        insertText = '* Target Object: `{{ log_entry.TargetObject }}`';
                        break;
                    case 'user':
                        insertText = '* User: `{{ log_entry.user }}`';
                        break;
                    case 'command':
                        insertText = '* Command: `{{ log_entry.command }}`';
                        break;
                    case 'process':
                        insertText = '* Process: `{{ log_entry.process }}`';
                        break;
                    case 'user-id':
                        insertText = '* User ID: `{{ log_entry.UserId }}`';
                        break;
                    case 'client-ip':
                        insertText = '* Client IP: `{{ log_entry.client_ip }}`';
                        break;
                    case 'host':
                        insertText = '* Host: `{{ log_entry.host }}`';
                        break;
                    case 'user-agent':
                        insertText = '* User Agent: `{{ log_entry.user_agent }}`';
                        break;
                    case 'result-status':
                        insertText = '* Result Status: `{{ log_entry.ResultStatus }}`';
                        break;
                    case 'user-key':
                        insertText = '* User Key: `{{ log_entry.UserKey }}`';
                        break;
                    case 'operation':
                        insertText = '* Operation: `{{ log_entry.Operation }}`';
                        break;
                    case 'object-id':
                        insertText = '* Object ID: `{{ log_entry.ObjectID }}`';
                        break;
                    case 'resource-type':
                        insertText = '* Resource Type: `{{ log_entry.resource.type }}`';
                        break;
                    case 'resource-id':
                        insertText = '* Resource ID: `{{ log_entry.resource.id }}`';
                        break;
                    case 'actor-ip':
                        insertText = '* Actor IP: `{{ log_entry.actor.ip }}`';
                        break;
                    case 'actor-type':
                        insertText = '* Actor Type: `{{ log_entry.actor.type }}`';
                        break;
                    case 'actor-id':
                        insertText = '* Actor ID: `{{ log_entry.actor.id }}`';
                        break;
                    case 'actor-email':
                        insertText = '* Actor Email: `{{ log_entry.actor.email }}`';
                        break;
                    case 'action-type':
                        insertText = '* Action Type: `{{ log_entry.action.type }}`';
                        break;
                    case 'action-result':
                        insertText = '* Action Result: `{{ log_entry.action.result }}`';
                        break;
                    case 'action-info':
                        insertText = '* Action Info: `{{ log_entry.action.info }}`';
                        break;
                }
                
                const insertMode = document.querySelector('input[name="insert-mode"]:checked').value;
                
                if (insertMode === 'cursor') {
                    // Insert at cursor position
                    const cursor = editor.getCursor();
                    editor.replaceRange(insertText + '\n', cursor);
                } else {
                    // Auto insert into the appropriate section
                    const content = editor.getValue();
                    const singleEventSection = content.indexOf('{% if log_entries.size == 1 -%}');
                    const multipleEventsSection = content.indexOf('{% else -%}');
                    
                    if (singleEventSection !== -1 && multipleEventsSection !== -1) {
                        // Find the position after the activity description in single event section
                        const singleEventDescEnd = content.indexOf('\n\n', singleEventSection) + 2;
                        
                        // Find the position in the multiple events section
                        const forLoopStart = content.indexOf('{% for log_entry in log_entries %}', multipleEventsSection);
                        const forLoopEnd = content.indexOf('{% endfor -%}', forLoopStart);
                        
                        // Insert in single event section with proper indentation
                        editor.replaceRange('  ' + insertText + '\n', {line: editor.posFromIndex(singleEventDescEnd).line, ch: 0});
                        
                        // Insert in multiple events section inside the for loop
                        if (forLoopStart !== -1 && forLoopEnd !== -1) {
                            // Find the last line inside the for loop
                            let lastLineInLoop = forLoopStart;
                            let currentPos = forLoopStart;
                            while (currentPos < forLoopEnd) {
                                const nextNewline = content.indexOf('\n', currentPos);
                                if (nextNewline === -1 || nextNewline > forLoopEnd) break;
                                lastLineInLoop = nextNewline;
                                currentPos = nextNewline + 1;
                            }
                            
                            // Insert after the last line in the for loop with proper indentation
                            const insertLine = editor.posFromIndex(lastLineInLoop).line;
                            editor.replaceRange('  ' + insertText + '\n', {line: insertLine, ch: 0});
                        }
                    }
                }
            });
        });

        // Function to show loading state on a button
        function showButtonLoading(buttonId) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            // Add the loading class
            button.classList.add('loading');
            
            // Create and add the spinner
            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            button.prepend(spinner);
            
            // Disable the button during loading
            button.disabled = true;
        }

        // Function to hide loading state and show success - with shorter duration
        function hideButtonLoading(buttonId, success = true, message = '') {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            // Get the spinner
            const spinner = button.querySelector('.spinner');
            
            // If there's a success/error message to show
            if (message) {
                // Keep the loading class but also add with-status
                button.classList.add('with-status');
                
                // Change spinner color based on success/error
                if (spinner) {
                    if (success) {
                        spinner.style.borderTopColor = '#4CAF50'; // Green for success
                    } else {
                        spinner.style.borderTopColor = '#f44336'; // Red for error
                    }
                }
                
                // Add status text
                const statusText = document.createElement('span');
                statusText.className = 'status-text';
                statusText.textContent = message;
                button.appendChild(statusText);
                
                // Reset button after shorter delay - 800ms instead of 2000ms
                setTimeout(() => {
                    resetButton(button);
                }, 800);
            } else {
                // Just reset the button immediately
                resetButton(button);
            }
        }

        // Helper function to reset button to original state
        function resetButton(button) {
            // Remove spinner
            const spinner = button.querySelector('.spinner');
            if (spinner) {
                spinner.remove();
            }
            
            // Remove status text
            const statusText = button.querySelector('.status-text');
            if (statusText) {
                statusText.remove();
            }
            
            // Remove classes
            button.classList.remove('loading', 'with-status');
            
            // Enable button
            button.disabled = false;
        }

        // Run button
        document.getElementById('run-btn').addEventListener('click', function() {
            showButtonLoading('run-btn');
            
            const template = editor.getValue();
            const logCount = parseInt(document.getElementById('log-count-select').value);
            
            fetch(`/api/run?log_count=${logCount}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    template: template,
                    data: {
                        log_count: logCount
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('output').textContent = data.result;
                    hideButtonLoading('run-btn', true, 'Success!');
                } else {
                    showNotification('Error: ' + data.error);
                    hideButtonLoading('run-btn', false, 'Error');
                }
            })
            .catch(error => {
                showNotification('Error running template: ' + error);
                hideButtonLoading('run-btn', false, 'Error');
            });
        });

        // Save button
        document.getElementById('save-btn').addEventListener('click', function() {
            showButtonLoading('save-btn');
            
            const content = editor.getValue();
            const currentTitle = document.querySelector('h1').textContent;
            
            // If there's no title, prompt for a name
            if (currentTitle === 'LiquidLogIDE ðŸ«—') {
                const templateName = prompt('Enter a name for your template:');
                if (!templateName) {
                    hideButtonLoading('save-btn');
                    return;
                }
                
                fetch('/api/save_template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        name: templateName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification('Saved template to Liquid Templates');
                        document.querySelector('h1').textContent = templateName;
                        hideButtonLoading('save-btn', true, 'Saved!');
                    } else {
                        showNotification('Error: ' + data.message);
                        hideButtonLoading('save-btn', false, 'Error');
                    }
                })
                .catch(error => {
                    showNotification('Error saving template: ' + error);
                    hideButtonLoading('save-btn', false, 'Error');
                });
            } else {
                // Use current title as template name
                fetch('/api/save_template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        name: currentTitle
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification('Saved template to Liquid Templates');
                        hideButtonLoading('save-btn', true, 'Saved!');
                    } else {
                        showNotification('Error: ' + data.message);
                        hideButtonLoading('save-btn', false, 'Error');
                    }
                })
                .catch(error => {
                    showNotification('Error saving template: ' + error);
                    hideButtonLoading('save-btn', false, 'Error');
                });
            }
        });

        // Upload button
        document.getElementById('upload-btn').addEventListener('click', function() {
            document.getElementById('json-upload').click();
        });

        document.getElementById('json-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                showButtonLoading('upload-btn');
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('company_name', document.getElementById('company-name').value);

                fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        editor.setValue(data.template);
                        document.querySelector('h1').textContent = data.title;
                        // Set the company name input field value
                        document.getElementById('company-name').value = data.company_name;
                        // Clear the file input so the same file can be selected again
                        e.target.value = '';
                        hideButtonLoading('upload-btn', true, 'Uploaded!');
                    } else {
                        alert('Error: ' + data.error);
                        // Clear the file input even on error
                        e.target.value = '';
                        hideButtonLoading('upload-btn', false, 'Error');
                    }
                })
                .catch(error => {
                    alert('Error uploading file: ' + error);
                    // Clear the file input on error
                    e.target.value = '';
                    hideButtonLoading('upload-btn', false, 'Error');
                });
            }
        });

        // Load button
        document.getElementById('load-btn').addEventListener('click', function() {
            document.getElementById('template-upload').click();
        });

        document.getElementById('template-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                showButtonLoading('load-btn');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    editor.setValue(content);
                    document.querySelector('h1').textContent = file.name.replace('.liquid', '');
                    showNotification(`Successfully loaded template: ${file.name}`);
                    hideButtonLoading('load-btn', true, 'Loaded!');
                };
                reader.onerror = function() {
                    showNotification(`Error loading template: ${file.name}`);
                    hideButtonLoading('load-btn', false, 'Error');
                };
                reader.readAsText(file);
                // Clear the file input so the same file can be selected again
                e.target.value = '';
            }
        });

        // Theme switching
        document.querySelectorAll('.theme-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all theme buttons
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to the clicked button
                this.classList.add('active');
                
                // Get the theme name
                const theme = this.getAttribute('data-theme');
                
                // Remove all theme classes from body
                document.body.classList.remove('theme-purple', 'theme-red', 'theme-green');
                
                // Add the selected theme class to body
                document.body.classList.add(`theme-${theme}`);
                
                // Save the theme preference in localStorage
                localStorage.setItem('theme', theme);
            });
        });

        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                // Remove active class from all theme buttons
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to the saved theme button
                const themeButton = document.querySelector(`.theme-btn[data-theme="${savedTheme}"]`);
                if (themeButton) {
                    themeButton.classList.add('active');
                }
                
                // Remove all theme classes from body
                document.body.classList.remove('theme-purple', 'theme-red', 'theme-green');
                
                // Add the saved theme class to body
                document.body.classList.add(`theme-${savedTheme}`);
            }
        });

        // Improved collapsible sections handling
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const toggleBtn = this.querySelector('.toggle-btn i');
                
                // Instead of toggling, explicitly check the current state
                if (content.classList.contains('open')) {
                    // Close the section
                    content.classList.remove('open');
                    toggleBtn.classList.remove('fa-chevron-up');
                    toggleBtn.classList.add('fa-chevron-down');
                } else {
                    // Open the section
                    content.classList.add('open');
                    toggleBtn.classList.remove('fa-chevron-down');
                    toggleBtn.classList.add('fa-chevron-up');
                }
                
                // Prevent event bubbling to avoid multiple toggles
                event.stopPropagation();
            });
        });

        // Open collapsible sections that were previously opened
        document.addEventListener('DOMContentLoaded', function() {
            // Check if any collapsible sections should be open based on localStorage
            const openSections = JSON.parse(localStorage.getItem('openSections') || '[]');
            
            openSections.forEach(index => {
                const header = document.querySelectorAll('.collapsible-header')[index];
                if (header) {
                    const content = header.nextElementSibling;
                    const toggleBtn = header.querySelector('.toggle-btn i');
                    
                    content.classList.add('open');
                    toggleBtn.classList.remove('fa-chevron-down');
                    toggleBtn.classList.add('fa-chevron-up');
                }
            });
            
            // Save open sections to localStorage when sections are toggled
            document.querySelectorAll('.collapsible-header').forEach((header, index) => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    let openSections = JSON.parse(localStorage.getItem('openSections') || '[]');
                    
                    if (content.classList.contains('open')) {
                        // Add this section to open sections if not already there
                        if (!openSections.includes(index)) {
                            openSections.push(index);
                        }
                    } else {
                        // Remove this section from open sections
                        openSections = openSections.filter(i => i !== index);
                    }
                    
                    localStorage.setItem('openSections', JSON.stringify(openSections));
                });
            });
        });

        // Add this to your JavaScript to help debug
        document.addEventListener('DOMContentLoaded', function() {
            // Debug log count selector
            const logCountSelect = document.getElementById('log-count-select');
            console.log('Log count selector:', logCountSelect);
            if (logCountSelect) {
                console.log('Log count is visible:', getComputedStyle(logCountSelect).display);
            }
        });

        // Define Liquid statement templates with proper syntax
        const liquidTemplates = {
            // If statement templates
            "if": "{% if condition %}\n  \n{% endif %}",
            "if/else": "{% if condition %}\n  \n{% else %}\n  \n{% endif %}",
            "if/elsif/else": "{% if condition %}\n  \n{% elsif condition %}\n  \n{% else %}\n  \n{% endif %}",
            
            // For loop templates
            "for": "{% for item in array %}\n  \n{% endfor %}",
            "for/else": "{% for item in array %}\n  \n{% else %}\n  \n{% endfor %}",
            "for-range": "{% for i in (1..5) %}\n  \n{% endfor %}",
            
            // Common variable templates
            "assign": "{% assign variable_name = value %}",
            "capture": "{% capture variable_name %}\n  \n{% endcapture %}",
            
            // Log-specific templates
            "log-entry": "{{ log_entry.field_name }}",
            "log-entries": "{{ log_entries[0].field_name }}",
            "size-check": "{% if log_entries.size == 1 -%}"
        };

        // Register our custom hint function for Liquid
        CodeMirror.registerHelper("hint", "liquid", function(editor) {
            const cursor = editor.getCursor();
            const line = editor.getLine(cursor.line);
            const lineText = line.substring(0, cursor.ch);
            
            let start = cursor.ch;
            let end = cursor.ch;
            
            // Find the start of the current word/partial command
            while (start > 0 && /[\w-]/.test(line.charAt(start - 1))) {
                start--;
            }
            
            const currentWord = line.substring(start, cursor.ch).toLowerCase();
            
            // Build a list of suggestions based on what the user has typed
            const suggestions = [];
            
            // Add templates for if/for commands
            if (/^\s*{%\s*$/.test(lineText) || lineText.endsWith('{%')) {
                // User has typed {% or is about to start a Liquid tag
                suggestions.push({
                    text: " if ", 
                    displayText: "if statement", 
                    render: function(element, data, current) {
                        element.innerHTML = '<span data-type="if">if statement</span>';
                    },
                    hint: function(cm, data, completion) {
                        cm.replaceRange(" if ", data.from, data.to);
                    }
                });
                
                suggestions.push({
                    text: " for ", 
                    displayText: "for loop", 
                    render: function(element, data, current) {
                        element.innerHTML = '<span data-type="for">for loop</span>';
                    },
                    hint: function(cm, data, completion) {
                        cm.replaceRange(" for ", data.from, data.to);
                    }
                });
                
                suggestions.push({
                    text: " assign ", 
                    displayText: "assign variable", 
                    render: function(element, data, current) {
                        element.innerHTML = '<span data-type="assign">assign variable</span>';
                    },
                    hint: function(cm, data, completion) {
                        cm.replaceRange(" assign ", data.from, data.to);
                    }
                });
            } else if (/^\s*{%\s*if\s*$/.test(lineText) || lineText.includes("{% if")) {
                // User is working on an if statement
                const template = liquidTemplates["if"];
                suggestions.push({
                    text: template,
                    displayText: "if condition",
                    render: function(element, data, current) {
                        element.innerHTML = '<span data-type="if">if condition</span>';
                    },
                    hint: function(cm, data, completion) {
                        const line = cm.getLine(cursor.line);
                        const replace = line.includes("{% if") ? false : true;
                        
                        if (replace) {
                            const from = {line: cursor.line, ch: 0};
                            const to = {line: cursor.line, ch: line.length};
                            cm.replaceRange(template, from, to);
                        } else {
                            // Just insert the end part
                            cm.replaceRange("\n  \n{% endif %}", cursor);
                        }
                        
                        // Position cursor after condition
                        const conditionPos = template.indexOf("condition") + line.indexOf("{% if");
                        cm.setCursor({line: cursor.line, ch: conditionPos});
                    }
                });
                
                // Add if/else suggestion
                suggestions.push({
                    text: liquidTemplates["if/else"],
                    displayText: "if/else statement",
                    render: function(element, data, current) {
                        element.innerHTML = '<span data-type="if">if/else statement</span>';
                    },
                    hint: function(cm, data, completion) {
                        const from = {line: cursor.line, ch: 0};
                        const to = {line: cursor.line, ch: line.length};
                        cm.replaceRange(liquidTemplates["if/else"], from, to);
                    }
                });
            } else if (/^\s*{%\s*for\s*$/.test(lineText) || lineText.includes("{% for")) {
                // User is working on a for loop
                const template = liquidTemplates["for"];
                suggestions.push({
                    text: template,
                    displayText: "for item in array",
                    render: function(element, data, current) {
                        element.innerHTML = '<span data-type="for">for item in array</span>';
                    },
                    hint: function(cm, data, completion) {
                        const line = cm.getLine(cursor.line);
                        const replace = line.includes("{% for") ? false : true;
                        
                        if (replace) {
                            const from = {line: cursor.line, ch: 0};
                            const to = {line: cursor.line, ch: line.length};
                            cm.replaceRange(template, from, to);
                        } else {
                            // Just insert the end part
                            cm.replaceRange("\n  \n{% endfor %}", cursor);
                        }
                        
                        // Position cursor after "item in "
                        const itemPos = template.indexOf("item in") + line.indexOf("{% for") + "item in".length + 1;
                        cm.setCursor({line: cursor.line, ch: itemPos});
                    }
                });
                
                // Add for/else suggestion
                suggestions.push({
                    text: liquidTemplates["for/else"],
                    displayText: "for/else loop",
                    render: function(element, data, current) {
                        element.innerHTML = '<span data-type="for">for/else loop</span>';
                    },
                    hint: function(cm, data, completion) {
                        const from = {line: cursor.line, ch: 0};
                        const to = {line: cursor.line, ch: line.length};
                        cm.replaceRange(liquidTemplates["for/else"], from, to);
                    }
                });
            } else {
                // Filter based on what the user has typed
                Object.keys(liquidTemplates).forEach(key => {
                    if (key.includes(currentWord)) {
                        let type = "assign";
                        if (key.startsWith("if")) type = "if";
                        if (key.startsWith("for")) type = "for";
                        
                        suggestions.push({
                            text: liquidTemplates[key],
                            displayText: key,
                            render: function(element, data, current) {
                                element.innerHTML = '<span data-type="' + type + '">' + key + '</span>';
                            },
                            hint: function(cm, data, completion) {
                                const from = {line: cursor.line, ch: 0};
                                const to = {line: cursor.line, ch: line.length};
                                cm.replaceRange(liquidTemplates[key], from, to);
                                
                                // Position cursor inside the block
                                const newLine = cursor.line + 1;
                                const indent = 2; // Indentation level
                                cm.setCursor({line: newLine, ch: indent});
                            }
                        });
                    }
                });
            }
            
            return {
                list: suggestions,
                from: CodeMirror.Pos(cursor.line, start),
                to: CodeMirror.Pos(cursor.line, end)
            };
        });

        // Trigger autocomplete on typing
        editor.on("keyup", function(cm, event) {
            // Keys that should trigger autocomplete
            const shouldComplete = (
                (event.key === "{") ||
                (event.key === "%") ||
                (event.key === "i" && cm.getLine(cm.getCursor().line).includes("{% ")) || 
                (event.key === "f" && cm.getLine(cm.getCursor().line).includes("{% "))
            );
            
            if (shouldComplete && !cm.state.completionActive) {
                CodeMirror.commands.autocomplete(cm, null, {completeSingle: false});
            }
        });

        // Add button to manually trigger autocomplete
        document.getElementById('format-btn').addEventListener('click', function() {
            CodeMirror.commands.autocomplete(editor, null, {completeSingle: false});
        });

        // Add this to your existing JavaScript
        document.querySelector('.log-upload-btn').addEventListener('click', function() {
            document.getElementById('log-json-upload').click();
        });

        document.getElementById('log-json-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // Parse the JSON log file
                        const logData = JSON.parse(e.target.result);
                        
                        // Extract variables
                        const variables = extractLogVariables(logData);
                        
                        // Switch to custom system
                        switchToCustomSystem(variables);
                        
                        // Show notification
                        showNotification(`Extracted ${variables.length} variables from log file`);
                    } catch (error) {
                        showNotification(`Error parsing JSON: ${error.message}`);
                    }
                };
                reader.readAsText(file);
                // Clear the file input
                e.target.value = '';
            }
        });

        // Function to extract variables from a JSON log
        function extractLogVariables(logData) {
            const variables = [];
            const paths = new Set();
            
            // Process the JSON to find all accessible paths
            function processObject(obj, path = '') {
                if (!obj || typeof obj !== 'object') return;
                
                // Handle arrays
                if (Array.isArray(obj)) {
                    if (obj.length > 0) {
                        processObject(obj[0], path ? `${path}[0]` : '[0]');
                    }
                    return;
                }
                
                // Process each property in the object
                for (const key in obj) {
                    const value = obj[key];
                    const newPath = path ? `${path}.${key}` : key;
                    
                    // Add this path to our list if it's a leaf node
                    if (typeof value !== 'object' || value === null) {
                        paths.add({
                            path: newPath,
                            type: typeof value,
                            value: value
                        });
                    }
                    
                    // Recursively process nested objects
                    if (value && typeof value === 'object') {
                        processObject(value, newPath);
                    }
                }
            }
            
            // Start processing the log data
            processObject(logData);
            
            // Clean paths and create display names
            function cleanPath(path) {
                // Remove common prefixes that shouldn't be part of the variable path
                if (path.startsWith('_source.')) {
                    path = path.replace(/^_source\./, '');
                }
                if (path.startsWith('logs.log[0].')) {
                    path = path.replace(/^logs\.log\[0]\./, '');
                }
                return path;
            }
            
            // Function to create a clean display name
            function createDisplayName(path) {
                // Clean the path first
                const cleanedPath = cleanPath(path);
                
                // Remove leading underscores from displayed parts
                return cleanedPath.split('.').map(part => {
                    // Remove array indices and leading underscores from each part
                    return part.replace(/\[\d+\]/g, '').replace(/^_/, '');
                }).join('.');
            }
            
            // Convert paths to variable objects
            paths.forEach(item => {
                // Clean the path for insertion
                const cleanedPath = cleanPath(item.path);
                
                // Create a clean display name without underscores
                const displayName = createDisplayName(item.path);
                
                variables.push({
                    name: cleanedPath,
                    fullPath: item.path,
                    type: item.type,
                    value: item.value,
                    display: displayName
                });
            });
            
            return variables;
        }

        // Function to switch to custom system and display variables
        function switchToCustomSystem(variables) {
            // Remove active class from all system buttons
            document.querySelectorAll('.system-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to the upload button
            document.querySelector('.log-upload-btn').classList.add('active');
            
            // Hide all system options
            document.querySelectorAll('.system-options').forEach(el => {
                el.classList.remove('active');
            });
            
            // Clear and update custom options div
            const customOptions = document.getElementById('custom-log-options');
            customOptions.innerHTML = '';
            customOptions.classList.add('active');
            
            // If no variables found
            if (variables.length === 0) {
                customOptions.innerHTML = '<div class="custom-log-empty">No variables found in the log file</div>';
                return;
            }
            
            // Create a header for the variables section
            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'variable-section-header';
            sectionHeader.textContent = 'Log Variables';
            sectionHeader.style.gridColumn = '1 / span 2';
            sectionHeader.style.fontWeight = 'bold';
            sectionHeader.style.marginBottom = '10px';
            sectionHeader.style.paddingBottom = '5px';
            sectionHeader.style.borderBottom = '1px solid var(--border-color)';
            customOptions.appendChild(sectionHeader);
            
            // Sort variables alphabetically by display name for easier browsing
            variables.sort((a, b) => a.display.localeCompare(b.display));
            
            // Add all variables directly without grouping
            variables.forEach(variable => {
                const btn = document.createElement('button');
                btn.className = 'template-btn extracted-variable';
                btn.dataset.template = `custom-var-${variable.name}`;
                btn.dataset.path = variable.name;
                btn.dataset.type = variable.type;
                
                // Set the button text to the variable display name
                btn.textContent = variable.display;
                
                // When clicked, insert at cursor position
                btn.addEventListener('click', function() {
                    const insertMode = document.querySelector('input[name="insert-mode"]:checked').value;
                    
                    if (insertMode === 'cursor') {
                        // For cursor position, use simple log_entries[0] format with cleaned path
                        let insertText = `{{ log_entries[0].${variable.name} }}`;
                        
                        // Insert at cursor position
                        const cursor = editor.getCursor();
                        editor.replaceRange(insertText, cursor);
                    } else {
                        // Auto insert mode implementation
                        // ...rest of the auto-insert code...
                    }
                });
                
                // Add button to the custom options container
                customOptions.appendChild(btn);
            });
        }

        // Update the function that determines what text to display on the button
        function getDisplayText(path, maxLength = 20) {
            if (path.length <= maxLength) return path;
            
            // If the text is too long, show the last part with ellipsis at the beginning
            return '...' + path.substring(path.length - maxLength);
        }

        // Add this after editor initialization
        // Enhance selection highlight behavior
        editor.on('cursorActivity', function(cm) {
            const selection = cm.getSelection();
            
            // When text is selected (and not just a cursor position)
            if (selection && selection.length >= 2) {
                // Force highlight matches to update
                cm.state.highlightSelectionMatches.overlay = null;
                cm.operation(function() {
                    cm.refresh();
                });
            }
        });

        // Also highlight matches when text is programmatically selected
        // via button clicks or other interactions
        function selectAndHighlightText(text) {
            const content = editor.getValue();
            const cursor = editor.getCursor();
            const pos = content.indexOf(text, cursor.ch);
            
            if (pos !== -1) {
                // Find the position in the document
                const doc = editor.getDoc();
                const startPos = doc.posFromIndex(pos);
                const endPos = doc.posFromIndex(pos + text.length);
                
                // Select the text
                doc.setSelection(startPos, endPos);
                
                // Scroll to the selection
                editor.scrollIntoView(startPos, 50);
            }
        }
    </script>
    {% endraw %}
</body>
</html> 