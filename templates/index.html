<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiquidLogIDE</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    {% raw %}
    <script>
        // Define Liquid mode
        CodeMirror.defineMode("liquid", function(config, parserConfig) {
            return {
                startState: function() {
                    return {
                        inLiquid: false,
                        inTag: false,
                        inVariable: false
                    };
                },
                token: function(stream, state) {
                    // Liquid tags
                    if (stream.match("{%")) {
                        state.inLiquid = true;
                        state.inTag = true;
                        return "liquid-tag";
                    }
                    if (stream.match("{{")) {
                        state.inLiquid = true;
                        state.inVariable = true;
                        return "liquid-variable";
                    }
                    if (state.inLiquid) {
                        if (stream.match("%}") && state.inTag) {
                            state.inLiquid = false;
                            state.inTag = false;
                            return "liquid-tag";
                        }
                        if (stream.match("}}") && state.inVariable) {
                            state.inLiquid = false;
                            state.inVariable = false;
                            return "liquid-variable";
                        }
                        if (state.inTag) {
                            if (stream.match(/\b(if|else|elsif|endif|for|endfor|assign|capture|endcapture|case|when|endcase)\b/)) {
                                return "liquid-keyword";
                            }
                            stream.next();
                            return "liquid-tag";
                        }
                        if (state.inVariable) {
                            stream.next();
                            return "liquid-variable";
                        }
                    }
                    stream.next();
                    return null;
                }
            };
        });

        // Add Liquid styles
        CodeMirror.defineMIME("text/liquid", "liquid");
    </script>
    {% endraw %}
    <style>
        .CodeMirror {
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .cm-liquid-tag {
            color: #f92672;
        }
        .cm-liquid-variable {
            color: #a6e22e;
        }
        .cm-liquid-keyword {
            color: #66d9ef;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="company-name">
                <h3>Name</h3>
                <input type="text" id="company-name" placeholder="Enter company name" value="COMPANY">
            </div>
            <div class="color-theme">
                <div class="collapsible-header">
                    <h3>Color Theme</h3>
                    <button class="toggle-btn"><i class="fas fa-chevron-down"></i></button>
                </div>
                <div class="collapsible-content">
                    <div class="theme-buttons">
                        <button class="theme-btn active" data-theme="purple">Purple</button>
                        <button class="theme-btn" data-theme="red">Candy Red</button>
                        <button class="theme-btn" data-theme="green">Lime Green</button>
                    </div>
                </div>
            </div>
            <div class="insert-mode">
                <h3>Insert Mode</h3>
                <div class="toggle-container">
                    <label class="toggle-label">
                        <input type="radio" name="insert-mode" value="cursor" checked>
                        <span>Cursor Position</span>
                    </label>
                    <label class="toggle-label">
                        <input type="radio" name="insert-mode" value="auto">
                        <span>Auto Insert</span>
                    </label>
                </div>
            </div>
            <div class="system-selector">
                <h3>Systems</h3>
                <div class="system-buttons">
                    <button class="system-btn active" data-system="windows">Windows</button>
                    <button class="system-btn" data-system="linux">Linux</button>
                    <button class="system-btn" data-system="entra">Entra ID</button>
                    <button class="system-btn" data-system="cloudflare">Cloudflare</button>
                    <button class="system-btn" data-system="Bitdefender">Bitdefender</button>
                </div>
            </div>
            <div class="outcome-templates">
                <h3>Outcome Templates</h3>
                <div id="windows-complex" class="system-complex active">
                    <button class="complex-btn" data-template="windows-outcome">Outcome Processing (Windows)</button>
                </div>
                <div id="linux-complex" class="system-complex">
                    <button class="complex-btn" data-template="linux-outcome">Outcome Processing (Linux)</button>
                </div>
                <div id="entra-complex" class="system-complex">
                    <button class="complex-btn" data-template="entra-outcome">Outcome Processing (Entra ID)</button>
                </div>
                <div id="cloudflare-complex" class="system-complex">
                    <button class="complex-btn" data-template="cloudflare-outcome">Outcome Processing (Cloudflare)</button>
                </div>
            </div>
            <div class="log-variables">
                <h3>Log Variables</h3>
                <div id="windows-options" class="system-options active">
                    <button class="template-btn" data-template="subject-user">Subject User</button>
                    <button class="template-btn" data-template="subject-user-sid">Subject User SID</button>
                    <button class="template-btn" data-template="target-domain-name">Target Domain Name</button>
                    <button class="template-btn" data-template="target-user">Target User</button>
                    <button class="template-btn" data-template="target-sid">Target SID</button>
                    <button class="template-btn" data-template="windows-hostname">Hostname</button>
                    <button class="template-btn" data-template="windows-message">Message</button>
                    <button class="template-btn" data-template="event-type">Event Type</button>
                    <button class="template-btn" data-template="event-code">Event Code</button>
                    <button class="template-btn" data-template="target-object">Target Object</button>
                </div>
                <div id="linux-options" class="system-options">
                    <button class="template-btn" data-template="user">User</button>
                    <button class="template-btn" data-template="command">Command</button>
                    <button class="template-btn" data-template="process">Process</button>
                </div>
                <div id="entra-options" class="system-options">
                    <button class="template-btn" data-template="user-id">User ID</button>
                    <button class="template-btn" data-template="result-status">Result Status</button>
                    <button class="template-btn" data-template="user-key">User Key</button>
                    <button class="template-btn" data-template="operation">Operation</button>
                    <button class="template-btn" data-template="object-id">Object ID</button>
                </div>
                <div id="cloudflare-options" class="system-options">
                    <button class="template-btn" data-template="resource-type">Resource Type</button>
                    <button class="template-btn" data-template="resource-id">Resource ID</button>
                    <button class="template-btn" data-template="actor-ip">Actor IP</button>
                    <button class="template-btn" data-template="actor-type">Actor Type</button>
                    <button class="template-btn" data-template="actor-id">Actor ID</button>
                    <button class="template-btn" data-template="actor-email">Actor Email</button>
                    <button class="template-btn" data-template="action-type">Action Type</button>
                    <button class="template-btn" data-template="action-result">Action Result</button>
                    <button class="template-btn" data-template="action-info">Action Info</button>
                </div>
            </div>
        </aside>
        <div class="main-content">
            <header>
                <h1>LiquidLogIDE 🫗</h1>
                <div class="controls">
                    <div class="file-upload">
                        <input type="file" id="json-upload" accept=".json" style="display: none;">
                        <button id="upload-btn"><span>Upload Sigma JSON</span></button>
                    </div>
                    <button id="save-btn"><span>Save Liquid Template</span></button>
                    <div class="file-upload">
                        <input type="file" id="template-upload" accept=".liquid" style="display: none;">
                        <button id="load-btn"><span>Load Liquid Template</span></button>
                    </div>
                </div>
            </header>
            <main>
                <div class="editor-container">
                    <div class="editor-header">
                        <h2>Liquid Template</h2>
                        <div class="editor-controls">
                            <button id="undo-btn" title="Undo"><i class="fas fa-undo"></i></button>
                            <button id="redo-btn" title="Redo"><i class="fas fa-redo"></i></button>
                            <button id="format-btn" title="Format"><i class="fas fa-code"></i></button>
                            <button id="clear-btn" title="Clear"><i class="fas fa-trash"></i></button>
                            <button id="run-btn" title="Run Template"><i class="fas fa-play"></i><span>Run</span></button>
                            <div class="log-count editor-log-count">
                                <label for="log-count-select">Logs:</label>
                                <select id="log-count-select" class="log-count-select">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="editor"></div>
                </div>
                <div class="output-container">
                    <h3>Output - Work In Progress</h3>
                    <div id="output"></div>
                </div>
            </main>
        </div>
    </div>

    {% raw %}
    <script>
        // Initialize CodeMirror
        const editor = CodeMirror(document.getElementById('editor'), {
            mode: 'liquid',
            theme: 'monokai',
            lineNumbers: true,
            autoCloseTags: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            lineWrapping: true,
            extraKeys: {
                "Ctrl-Space": "autocomplete"
            }
        });

        // Editor control buttons
        document.getElementById('undo-btn').addEventListener('click', () => {
            editor.undo();
        });

        document.getElementById('redo-btn').addEventListener('click', () => {
            editor.redo();
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the editor?')) {
                editor.setValue('');
            }
        });

        document.getElementById('format-btn').addEventListener('click', () => {
            const content = editor.getValue();
            // Basic formatting - you might want to enhance this
            const formatted = content
                .replace(/\{\{/g, '{{ ')
                .replace(/\}\}/g, ' }}')
                .replace(/\{%/g, '{% ')
                .replace(/%\}/g, ' %}')
                .replace(/\s+/g, ' ')
                .trim();
            editor.setValue(formatted);
        });

        // System selection handling
        document.querySelectorAll('.system-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all system buttons and options
                document.querySelectorAll('.system-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.system-options').forEach(opt => opt.classList.remove('active'));
                document.querySelectorAll('.system-complex').forEach(opt => opt.classList.remove('active'));
                
                // Add active class to clicked button and corresponding options
                this.classList.add('active');
                document.getElementById(this.dataset.system + '-options').classList.add('active');
                document.getElementById(this.dataset.system + '-complex').classList.add('active');
            });
        });

        // Complex template button handling
        document.querySelectorAll('.complex-btn').forEach(button => {
            button.addEventListener('click', function() {
                const template = this.dataset.template;
                let insertText = '';
                
                switch(template) {
                    case 'windows-outcome':
                        insertText = `{% assign result = log_entries[0].event.outcome | strip -%}
  {% if result == "failure" -%}
    {% assign result = "failed" %}
  {% elsif result == "success" -%}
    {% assign result = "succeeded" %}
  {% endif -%}`;
                        break;
                    case 'linux-outcome':
                        insertText = `{% assign result = log_entries[0].event.outcome | strip -%}
  {% if result == "failure" -%}
    {% assign result = "failed" %}
  {% elsif result == "success" -%}
    {% assign result = "succeeded" %}
  {% endif -%}`;
                        break;
                    case 'entra-outcome':
                        insertText = `{% assign result = log_entries[0].event.outcome | strip -%}
  {% if result == "failure" -%}
    {% assign result = "failed" %}
  {% elsif result == "success" -%}
    {% assign result = "succeeded" %}
  {% endif -%}`;
                        break;
                    case 'cloudflare-outcome':
                        insertText = `{% assign result = log_entries[0].event.outcome | strip -%}
  {% if result == "failure" -%}
    {% assign result = "failed" %}
  {% elsif result == "success" -%}
    {% assign result = "succeeded" %}
  {% endif -%}`;
                        break;
                }
                
                const insertMode = document.querySelector('input[name="insert-mode"]:checked').value;
                
                if (insertMode === 'cursor') {
                    // Insert at cursor position
                    const cursor = editor.getCursor();
                    editor.replaceRange(insertText + '\n', cursor);
                } else {
                    // Auto insert into the appropriate section
                    const content = editor.getValue();
                    const singleEventSection = content.indexOf('{% if log_entries.size == 1 -%}');
                    const multipleEventsSection = content.indexOf('{% else -%}');
                    
                    if (singleEventSection !== -1 && multipleEventsSection !== -1) {
                        // Find the position after the activity description in single event section
                        const singleEventDescEnd = content.indexOf('\n\n', singleEventSection) + 2;
                        
                        // Find the position in the multiple events section
                        const forLoopStart = content.indexOf('{% for log_entry in log_entries %}', multipleEventsSection);
                        const forLoopEnd = content.indexOf('{% endfor -%}', forLoopStart);
                        
                        // Insert in single event section with proper indentation
                        editor.replaceRange('  ' + insertText + '\n', {line: editor.posFromIndex(singleEventDescEnd).line, ch: 0});
                        
                        // Insert in multiple events section inside the for loop
                        if (forLoopStart !== -1 && forLoopEnd !== -1) {
                            // Find the last line inside the for loop
                            let lastLineInLoop = forLoopStart;
                            let currentPos = forLoopStart;
                            while (currentPos < forLoopEnd) {
                                const nextNewline = content.indexOf('\n', currentPos);
                                if (nextNewline === -1 || nextNewline > forLoopEnd) break;
                                lastLineInLoop = nextNewline;
                                currentPos = nextNewline + 1;
                            }
                            
                            // Insert after the last line in the for loop with proper indentation
                            const insertLine = editor.posFromIndex(lastLineInLoop).line;
                            editor.replaceRange('  ' + insertText + '\n', {line: insertLine, ch: 0});
                        }
                    }
                }
            });
        });

        // Log Variables button handling
        document.querySelectorAll('.template-btn').forEach(button => {
            button.addEventListener('click', function() {
                const template = this.dataset.template;
                let insertText = '';
                
                switch(template) {
                    case 'subject-user':
                        insertText = '* Subject User: `{{ log_entry.SubjectUserName }}`';
                        break;
                    case 'subject-user-sid':
                        insertText = '* Subject User SID: `{{ log_entry.SubjectUserSid }}`';
                        break;
                    case 'target-domain-name':
                        insertText = '* Target Domain Name: `{{ log_entry.TargetDomainName }}`';
                        break;
                    case 'target-user':
                        insertText = '* Target User: `{{ log_entry.TargetUserName }}`';
                        break;
                    case 'target-sid':
                        insertText = '* Target SID: `{{ log_entry.TargetUserSid }}`';
                        break;
                    case 'windows-hostname':
                        insertText = '* Hostname: `{{ log_entry.hostname }}`';
                        break;
                    case 'windows-message':
                        insertText = '* Message: `{{ log_entry.message }}`';
                        break;
                    case 'event-type':
                        insertText = '* Event Type: `{{ log_entry.EventType }}`';
                        break;
                    case 'event-code':
                        insertText = '* Event Code: `{{ log_entry.event.code }}`';
                        break;
                    case 'target-object':
                        insertText = '* Target Object: `{{ log_entry.TargetObject }}`';
                        break;
                    case 'user':
                        insertText = '* User: `{{ log_entry.user }}`';
                        break;
                    case 'command':
                        insertText = '* Command: `{{ log_entry.command }}`';
                        break;
                    case 'process':
                        insertText = '* Process: `{{ log_entry.process }}`';
                        break;
                    case 'user-id':
                        insertText = '* User ID: `{{ log_entry.UserId }}`';
                        break;
                    case 'client-ip':
                        insertText = '* Client IP: `{{ log_entry.client_ip }}`';
                        break;
                    case 'host':
                        insertText = '* Host: `{{ log_entry.host }}`';
                        break;
                    case 'user-agent':
                        insertText = '* User Agent: `{{ log_entry.user_agent }}`';
                        break;
                    case 'result-status':
                        insertText = '* Result Status: `{{ log_entry.ResultStatus }}`';
                        break;
                    case 'user-key':
                        insertText = '* User Key: `{{ log_entry.UserKey }}`';
                        break;
                    case 'operation':
                        insertText = '* Operation: `{{ log_entry.Operation }}`';
                        break;
                    case 'object-id':
                        insertText = '* Object ID: `{{ log_entry.ObjectID }}`';
                        break;
                    case 'resource-type':
                        insertText = '* Resource Type: `{{ log_entry.resource.type }}`';
                        break;
                    case 'resource-id':
                        insertText = '* Resource ID: `{{ log_entry.resource.id }}`';
                        break;
                    case 'actor-ip':
                        insertText = '* Actor IP: `{{ log_entry.actor.ip }}`';
                        break;
                    case 'actor-type':
                        insertText = '* Actor Type: `{{ log_entry.actor.type }}`';
                        break;
                    case 'actor-id':
                        insertText = '* Actor ID: `{{ log_entry.actor.id }}`';
                        break;
                    case 'actor-email':
                        insertText = '* Actor Email: `{{ log_entry.actor.email }}`';
                        break;
                    case 'action-type':
                        insertText = '* Action Type: `{{ log_entry.action.type }}`';
                        break;
                    case 'action-result':
                        insertText = '* Action Result: `{{ log_entry.action.result }}`';
                        break;
                    case 'action-info':
                        insertText = '* Action Info: `{{ log_entry.action.info }}`';
                        break;
                }
                
                const insertMode = document.querySelector('input[name="insert-mode"]:checked').value;
                
                if (insertMode === 'cursor') {
                    // Insert at cursor position
                    const cursor = editor.getCursor();
                    editor.replaceRange(insertText + '\n', cursor);
                } else {
                    // Auto insert into the appropriate section
                    const content = editor.getValue();
                    const singleEventSection = content.indexOf('{% if log_entries.size == 1 -%}');
                    const multipleEventsSection = content.indexOf('{% else -%}');
                    
                    if (singleEventSection !== -1 && multipleEventsSection !== -1) {
                        // Find the position after the activity description in single event section
                        const singleEventDescEnd = content.indexOf('\n\n', singleEventSection) + 2;
                        
                        // Find the position in the multiple events section
                        const forLoopStart = content.indexOf('{% for log_entry in log_entries %}', multipleEventsSection);
                        const forLoopEnd = content.indexOf('{% endfor -%}', forLoopStart);
                        
                        // Insert in single event section with proper indentation
                        editor.replaceRange('  ' + insertText + '\n', {line: editor.posFromIndex(singleEventDescEnd).line, ch: 0});
                        
                        // Insert in multiple events section inside the for loop
                        if (forLoopStart !== -1 && forLoopEnd !== -1) {
                            // Find the last line inside the for loop
                            let lastLineInLoop = forLoopStart;
                            let currentPos = forLoopStart;
                            while (currentPos < forLoopEnd) {
                                const nextNewline = content.indexOf('\n', currentPos);
                                if (nextNewline === -1 || nextNewline > forLoopEnd) break;
                                lastLineInLoop = nextNewline;
                                currentPos = nextNewline + 1;
                            }
                            
                            // Insert after the last line in the for loop with proper indentation
                            const insertLine = editor.posFromIndex(lastLineInLoop).line;
                            editor.replaceRange('  ' + insertText + '\n', {line: insertLine, ch: 0});
                        }
                    }
                }
            });
        });

        // Function to show loading state on a button
        function showButtonLoading(buttonId) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            // Add the loading class
            button.classList.add('loading');
            
            // Create and add the spinner
            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            button.prepend(spinner);
            
            // Disable the button during loading
            button.disabled = true;
        }

        // Function to hide loading state and show success - with shorter duration
        function hideButtonLoading(buttonId, success = true, message = '') {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            // Get the spinner
            const spinner = button.querySelector('.spinner');
            
            // If there's a success/error message to show
            if (message) {
                // Keep the loading class but also add with-status
                button.classList.add('with-status');
                
                // Change spinner color based on success/error
                if (spinner) {
                    if (success) {
                        spinner.style.borderTopColor = '#4CAF50'; // Green for success
                    } else {
                        spinner.style.borderTopColor = '#f44336'; // Red for error
                    }
                }
                
                // Add status text
                const statusText = document.createElement('span');
                statusText.className = 'status-text';
                statusText.textContent = message;
                button.appendChild(statusText);
                
                // Reset button after shorter delay - 800ms instead of 2000ms
                setTimeout(() => {
                    resetButton(button);
                }, 800);
            } else {
                // Just reset the button immediately
                resetButton(button);
            }
        }

        // Helper function to reset button to original state
        function resetButton(button) {
            // Remove spinner
            const spinner = button.querySelector('.spinner');
            if (spinner) {
                spinner.remove();
            }
            
            // Remove status text
            const statusText = button.querySelector('.status-text');
            if (statusText) {
                statusText.remove();
            }
            
            // Remove classes
            button.classList.remove('loading', 'with-status');
            
            // Enable button
            button.disabled = false;
        }

        // Run button
        document.getElementById('run-btn').addEventListener('click', function() {
            showButtonLoading('run-btn');
            
            const template = editor.getValue();
            const logCount = parseInt(document.getElementById('log-count-select').value);
            
            fetch(`/api/run?log_count=${logCount}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    template: template,
                    data: {
                        log_count: logCount
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('output').textContent = data.result;
                    hideButtonLoading('run-btn', true, 'Success!');
                } else {
                    showNotification('Error: ' + data.error);
                    hideButtonLoading('run-btn', false, 'Error');
                }
            })
            .catch(error => {
                showNotification('Error running template: ' + error);
                hideButtonLoading('run-btn', false, 'Error');
            });
        });

        // Save button
        document.getElementById('save-btn').addEventListener('click', function() {
            showButtonLoading('save-btn');
            
            const content = editor.getValue();
            const currentTitle = document.querySelector('h1').textContent;
            
            // If there's no title, prompt for a name
            if (currentTitle === 'LiquidLogIDE 🫗') {
                const templateName = prompt('Enter a name for your template:');
                if (!templateName) {
                    hideButtonLoading('save-btn');
                    return;
                }
                
                fetch('/api/save_template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        name: templateName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification('Saved template to Liquid Templates');
                        document.querySelector('h1').textContent = templateName;
                        hideButtonLoading('save-btn', true, 'Saved!');
                    } else {
                        showNotification('Error: ' + data.message);
                        hideButtonLoading('save-btn', false, 'Error');
                    }
                })
                .catch(error => {
                    showNotification('Error saving template: ' + error);
                    hideButtonLoading('save-btn', false, 'Error');
                });
            } else {
                // Use current title as template name
                fetch('/api/save_template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        name: currentTitle
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showNotification('Saved template to Liquid Templates');
                        hideButtonLoading('save-btn', true, 'Saved!');
                    } else {
                        showNotification('Error: ' + data.message);
                        hideButtonLoading('save-btn', false, 'Error');
                    }
                })
                .catch(error => {
                    showNotification('Error saving template: ' + error);
                    hideButtonLoading('save-btn', false, 'Error');
                });
            }
        });

        // Upload button
        document.getElementById('upload-btn').addEventListener('click', function() {
            document.getElementById('json-upload').click();
        });

        document.getElementById('json-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                showButtonLoading('upload-btn');
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('company_name', document.getElementById('company-name').value);

                fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        editor.setValue(data.template);
                        document.querySelector('h1').textContent = data.title;
                        // Set the company name input field value
                        document.getElementById('company-name').value = data.company_name;
                        // Clear the file input so the same file can be selected again
                        e.target.value = '';
                        hideButtonLoading('upload-btn', true, 'Uploaded!');
                    } else {
                        alert('Error: ' + data.error);
                        // Clear the file input even on error
                        e.target.value = '';
                        hideButtonLoading('upload-btn', false, 'Error');
                    }
                })
                .catch(error => {
                    alert('Error uploading file: ' + error);
                    // Clear the file input on error
                    e.target.value = '';
                    hideButtonLoading('upload-btn', false, 'Error');
                });
            }
        });

        // Load button
        document.getElementById('load-btn').addEventListener('click', function() {
            document.getElementById('template-upload').click();
        });

        document.getElementById('template-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                showButtonLoading('load-btn');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    editor.setValue(content);
                    document.querySelector('h1').textContent = file.name.replace('.liquid', '');
                    showNotification(`Successfully loaded template: ${file.name}`);
                    hideButtonLoading('load-btn', true, 'Loaded!');
                };
                reader.onerror = function() {
                    showNotification(`Error loading template: ${file.name}`);
                    hideButtonLoading('load-btn', false, 'Error');
                };
                reader.readAsText(file);
                // Clear the file input so the same file can be selected again
                e.target.value = '';
            }
        });

        // Theme switching
        document.querySelectorAll('.theme-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all theme buttons
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to the clicked button
                this.classList.add('active');
                
                // Get the theme name
                const theme = this.getAttribute('data-theme');
                
                // Remove all theme classes from body
                document.body.classList.remove('theme-purple', 'theme-red', 'theme-green');
                
                // Add the selected theme class to body
                document.body.classList.add(`theme-${theme}`);
                
                // Save the theme preference in localStorage
                localStorage.setItem('theme', theme);
            });
        });

        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                // Remove active class from all theme buttons
                document.querySelectorAll('.theme-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to the saved theme button
                const themeButton = document.querySelector(`.theme-btn[data-theme="${savedTheme}"]`);
                if (themeButton) {
                    themeButton.classList.add('active');
                }
                
                // Remove all theme classes from body
                document.body.classList.remove('theme-purple', 'theme-red', 'theme-green');
                
                // Add the saved theme class to body
                document.body.classList.add(`theme-${savedTheme}`);
            }
        });

        // Improved collapsible sections handling
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const toggleBtn = this.querySelector('.toggle-btn i');
                
                // Instead of toggling, explicitly check the current state
                if (content.classList.contains('open')) {
                    // Close the section
                    content.classList.remove('open');
                    toggleBtn.classList.remove('fa-chevron-up');
                    toggleBtn.classList.add('fa-chevron-down');
                } else {
                    // Open the section
                    content.classList.add('open');
                    toggleBtn.classList.remove('fa-chevron-down');
                    toggleBtn.classList.add('fa-chevron-up');
                }
                
                // Prevent event bubbling to avoid multiple toggles
                event.stopPropagation();
            });
        });

        // Open collapsible sections that were previously opened
        document.addEventListener('DOMContentLoaded', function() {
            // Check if any collapsible sections should be open based on localStorage
            const openSections = JSON.parse(localStorage.getItem('openSections') || '[]');
            
            openSections.forEach(index => {
                const header = document.querySelectorAll('.collapsible-header')[index];
                if (header) {
                    const content = header.nextElementSibling;
                    const toggleBtn = header.querySelector('.toggle-btn i');
                    
                    content.classList.add('open');
                    toggleBtn.classList.remove('fa-chevron-down');
                    toggleBtn.classList.add('fa-chevron-up');
                }
            });
            
            // Save open sections to localStorage when sections are toggled
            document.querySelectorAll('.collapsible-header').forEach((header, index) => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    let openSections = JSON.parse(localStorage.getItem('openSections') || '[]');
                    
                    if (content.classList.contains('open')) {
                        // Add this section to open sections if not already there
                        if (!openSections.includes(index)) {
                            openSections.push(index);
                        }
                    } else {
                        // Remove this section from open sections
                        openSections = openSections.filter(i => i !== index);
                    }
                    
                    localStorage.setItem('openSections', JSON.stringify(openSections));
                });
            });
        });

        // Add this to your JavaScript to help debug
        document.addEventListener('DOMContentLoaded', function() {
            // Debug log count selector
            const logCountSelect = document.getElementById('log-count-select');
            console.log('Log count selector:', logCountSelect);
            if (logCountSelect) {
                console.log('Log count is visible:', getComputedStyle(logCountSelect).display);
            }
        });
    </script>
    {% endraw %}
</body>
</html> 